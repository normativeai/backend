var assert = require('assert')
const fs = require('fs');
const chai = require('chai');
const { expect } = chai;

var exporter = require('../models/jsonCNLExporter')

let json_rome = fs.readFileSync("./test/fixtures/rome1.json", "utf8");
let json_gdpr = fs.readFileSync("./test/fixtures/gdpr.json", "utf8");
let json_art13_1 = fs.readFileSync("./test/fixtures/gdpr_13_1.json", "utf8");
let json_art13_2 = fs.readFileSync("./test/fixtures/gdpr_13_2.json", "utf8");
let json_art13_3 = fs.readFileSync("./test/fixtures/gdpr_13_3.json", "utf8");
let json_art13_4 = fs.readFileSync("./test/fixtures/gdpr_13_4.json", "utf8");

const pairs = [
  ['{"text": "aaa","connective": {"code": "or", "formulas": [{"text": "aaa", "term": {"name": "a"}},{"text": "aaa", "term": {"name": "b"}}, {"text": "aaa", "term": {"name": "c"}}] } }','&nbsp;aaa[a]<BR/>&nbsp;OR aaa[b]<BR/>&nbsp;OR aaa[c]'],
  [json_rome, '&nbsp;IF<BR/>&nbsp;&nbsp;the law chosen by the parties[validChoice(Law,Part)]<BR/>&nbsp;THEN YOU MUST<BR/>&nbsp;&nbsp;A contract[contract(Law,Part)]<BR/>'],
];

describe("JSON CNL Exporter", function(){
  it(`should export ${pairs[0][0]} correctly`, function(done){
    assert.equal(exporter.exportFormula(JSON.parse(pairs[0][0]), {level:1}), pairs[0][1]);
    done();
  });
  it(`should parse ${pairs[1][0]} correctly`, function(done){
    assert.equal(exporter.exportFormula(JSON.parse(pairs[1][0]), {level:1}), pairs[1][1]);
    done();
  });
  it("should parse correctly the GDPR JSON", function(done) {
    let gdpr = JSON.parse(json_gdpr)
    assert.equal(exporter.exportFormula(gdpr, {level:1}), "&nbsp;IF<BR/>&nbsp;&nbsp;&nbsp;processor[processor(X)]<BR/>&nbsp;AND nominated by the controller[nominate(Y,X)]<BR/>&nbsp;AND process the data[personal_data_processed_at_time(X,Z,T)]<BR/>&nbsp;AND personal data[personal_data(Z,W)]<BR/>&nbsp;AND data subject[data_subject(W)]<BR/>&nbsp;AND controller[controller(Y,Z)]<BR/>&nbsp;THEN YOU MUST<BR/>&nbsp;&nbsp;at the time when personal data are obtained, provide the data subject with all of the following information[communicate_at_time(Y,W,T,the identity and the contact details of the controller[contact_details(Y)])]<BR/> AND &nbsp;IF<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;processor[processor(X)]<BR/>&nbsp;&nbsp;AND nominated by the controller[nominate(Y,X)]<BR/>&nbsp;&nbsp;AND process the data[personal_data_processed_at_time(X,Z,T)]<BR/>&nbsp;&nbsp;AND personal data[personal_data(Z,W)]<BR/>&nbsp;&nbsp;AND data subject[data_subject(W)]<BR/>&nbsp;&nbsp;AND controller[controller(Y,Z)]<BR/>&nbsp;AND where applicable[representative(K,Y)]<BR/>&nbsp;THEN YOU MUST<BR/>&nbsp;&nbsp;at the time when personal data are obtained, provide the data subject with all of the following information[communicate_at_time(Y,W,T,of the controller’s representative[contact_details(K)])]<BR/>")
    done();
  });
  it("should parse correctly obmacro1 containing VAR on the left side as well", function(done) {
    let gdpr = JSON.parse(json_gdpr)
    let cond = gdpr.connective.formulas[0]
    let lhsVAR = {
					"text":"at the time when personal data are obtained, provide the data subject with all of the following information",
					"term":
					{
						"name":"communicate_at_time(Y,W,T,VAR)"
					}
				}
    let newCond = exporter.createConnective("and", [lhsVAR, cond])
    gdpr.connective.formulas[0] = newCond
    assert.equal(exporter.exportFormula(gdpr, {level:1}), "&nbsp;IF<BR/>&nbsp;&nbsp;&nbsp;at the time when personal data are obtained, provide the data subject with all of the following information[communicate_at_time(Y,W,T,the identity and the contact details of the controller[contact_details(Y)])]<BR/>&nbsp;AND &nbsp;&nbsp;processor[processor(X)]<BR/>&nbsp;&nbsp;AND nominated by the controller[nominate(Y,X)]<BR/>&nbsp;&nbsp;AND process the data[personal_data_processed_at_time(X,Z,T)]<BR/>&nbsp;&nbsp;AND personal data[personal_data(Z,W)]<BR/>&nbsp;&nbsp;AND data subject[data_subject(W)]<BR/>&nbsp;&nbsp;AND controller[controller(Y,Z)]<BR/>&nbsp;THEN YOU MUST<BR/>&nbsp;&nbsp;at the time when personal data are obtained, provide the data subject with all of the following information[communicate_at_time(Y,W,T,the identity and the contact details of the controller[contact_details(Y)])]<BR/> AND &nbsp;IF<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;at the time when personal data are obtained, provide the data subject with all of the following information[communicate_at_time(Y,W,T,of the controller’s representative[contact_details(K)])]<BR/>&nbsp;&nbsp;AND &nbsp;&nbsp;&nbsp;processor[processor(X)]<BR/>&nbsp;&nbsp;&nbsp;AND nominated by the controller[nominate(Y,X)]<BR/>&nbsp;&nbsp;&nbsp;AND process the data[personal_data_processed_at_time(X,Z,T)]<BR/>&nbsp;&nbsp;&nbsp;AND personal data[personal_data(Z,W)]<BR/>&nbsp;&nbsp;&nbsp;AND data subject[data_subject(W)]<BR/>&nbsp;&nbsp;&nbsp;AND controller[controller(Y,Z)]<BR/>&nbsp;AND where applicable[representative(K,Y)]<BR/>&nbsp;THEN YOU MUST<BR/>&nbsp;&nbsp;at the time when personal data are obtained, provide the data subject with all of the following information[communicate_at_time(Y,W,T,of the controller’s representative[contact_details(K)])]<BR/>")
    done();
  });

  it("should parse correctly obmacro1 in art13-1", function(done) {
    let gdpr = JSON.parse(json_art13_1)
    assert.equal(exporter.exportFormula(gdpr, {level:1, map: new Map()}), "&nbsp;a13_p1)&nbsp;&nbsp;IF<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NOT<BR/>&nbsp;&nbsp;&nbsp;&nbsp;the data subject already has the information[already_has(Subject, the identity and the contact details of the controller[contact_details(Controller)])]<BR/>&nbsp;&nbsp;AND &nbsp;&nbsp;&nbsp;processor[processor(Processor)]<BR/>&nbsp;&nbsp;&nbsp;AND nominated by the controller[nominate(Controller, Processor)]<BR/>&nbsp;&nbsp;&nbsp;AND process the data[personal_data_processed(Processor, Data, Time, Justification, Purpose)]<BR/>&nbsp;&nbsp;&nbsp;AND personal data[personal_data(Data,Subject)]<BR/>&nbsp;&nbsp;&nbsp;AND data subject[data_subject(Subject)]<BR/>&nbsp;&nbsp;&nbsp;AND controller[controller(Controller, Data)]<BR/>&nbsp;&nbsp;THEN YOU MUST<BR/>&nbsp;&nbsp;&nbsp;at the time when personal data are obtained, provide the data subject with all of the following information[communicate_at_time(Controller, Subject, Time, the identity and the contact details of the controller[contact_details(Controller)])]<BR/> AND &nbsp;&nbsp;IF<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NOT<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the data subject already has the information[already_has(Subject, of the controller’s representative[contact_details(Representive)])]<BR/>&nbsp;&nbsp;&nbsp;AND &nbsp;&nbsp;&nbsp;&nbsp;processor[processor(Processor)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND nominated by the controller[nominate(Controller, Processor)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND process the data[personal_data_processed(Processor, Data, Time, Justification, Purpose)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND personal data[personal_data(Data,Subject)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND data subject[data_subject(Subject)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND controller[controller(Controller, Data)]<BR/>&nbsp;&nbsp;AND where applicable[representive(Controller, Representive)]<BR/>&nbsp;&nbsp;THEN YOU MUST<BR/>&nbsp;&nbsp;&nbsp;at the time when personal data are obtained, provide the data subject with all of the following information[communicate_at_time(Controller, Subject, Time, of the controller’s representative[contact_details(Representive)])]<BR/> AND &nbsp;&nbsp;IF<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NOT<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the data subject already has the information[already_has(Subject, the contact details of the data protection officer[contact_details(DPO)])]<BR/>&nbsp;&nbsp;&nbsp;AND &nbsp;&nbsp;&nbsp;&nbsp;processor[processor(Processor)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND nominated by the controller[nominate(Controller, Processor)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND process the data[personal_data_processed(Processor, Data, Time, Justification, Purpose)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND personal data[personal_data(Data,Subject)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND data subject[data_subject(Subject)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND controller[controller(Controller, Data)]<BR/>&nbsp;&nbsp;AND where applicable[data_protection_officer(DPO,Data)]<BR/>&nbsp;&nbsp;THEN YOU MUST<BR/>&nbsp;&nbsp;&nbsp;at the time when personal data are obtained, provide the data subject with all of the following information[communicate_at_time(Controller, Subject, Time, the contact details of the data protection officer[contact_details(DPO)])]<BR/> AND &nbsp;&nbsp;IF<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NOT<BR/>&nbsp;&nbsp;&nbsp;&nbsp;the data subject already has the information[already_has(Subject, purposes of the processing[purpose_of_processing(Purpose, Data)])]<BR/>&nbsp;&nbsp;AND &nbsp;&nbsp;&nbsp;processor[processor(Processor)]<BR/>&nbsp;&nbsp;&nbsp;AND nominated by the controller[nominate(Controller, Processor)]<BR/>&nbsp;&nbsp;&nbsp;AND process the data[personal_data_processed(Processor, Data, Time, Justification, Purpose)]<BR/>&nbsp;&nbsp;&nbsp;AND personal data[personal_data(Data,Subject)]<BR/>&nbsp;&nbsp;&nbsp;AND data subject[data_subject(Subject)]<BR/>&nbsp;&nbsp;&nbsp;AND controller[controller(Controller, Data)]<BR/>&nbsp;&nbsp;THEN YOU MUST<BR/>&nbsp;&nbsp;&nbsp;at the time when personal data are obtained, provide the data subject with all of the following information[communicate_at_time(Controller, Subject, Time, purposes of the processing[purpose_of_processing(Purpose, Data)])]<BR/> AND &nbsp;&nbsp;IF<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NOT<BR/>&nbsp;&nbsp;&nbsp;&nbsp;the data subject already has the information[already_has(Subject, legal basis for the processing[legal_basis(LegalBasis, Purpose)])]<BR/>&nbsp;&nbsp;AND &nbsp;&nbsp;&nbsp;processor[processor(Processor)]<BR/>&nbsp;&nbsp;&nbsp;AND nominated by the controller[nominate(Controller, Processor)]<BR/>&nbsp;&nbsp;&nbsp;AND process the data[personal_data_processed(Processor, Data, Time, Justification, Purpose)]<BR/>&nbsp;&nbsp;&nbsp;AND personal data[personal_data(Data,Subject)]<BR/>&nbsp;&nbsp;&nbsp;AND data subject[data_subject(Subject)]<BR/>&nbsp;&nbsp;&nbsp;AND controller[controller(Controller, Data)]<BR/>&nbsp;&nbsp;THEN YOU MUST<BR/>&nbsp;&nbsp;&nbsp;at the time when personal data are obtained, provide the data subject with all of the following information[communicate_at_time(Controller, Subject, Time, legal basis for the processing[legal_basis(LegalBasis, Purpose)])]<BR/> AND &nbsp;&nbsp;IF<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NOT<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the data subject already has the information[already_has(Subject, the legitimate interests pursued by the controller or by a third party[legitimate_interest_third_party_or(Party,Controller)])]<BR/>&nbsp;&nbsp;&nbsp;AND &nbsp;&nbsp;&nbsp;&nbsp;processor[processor(Processor)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND nominated by the controller[nominate(Controller, Processor)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND process the data[personal_data_processed(Processor, Data, Time, Justification, Purpose)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND personal data[personal_data(Data,Subject)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND data subject[data_subject(Subject)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND controller[controller(Controller, Data)]<BR/>&nbsp;&nbsp;AND where the processing is based on point (f) of Article 6(1)[justification_based(Justification, article_6_1)]<BR/>&nbsp;&nbsp;THEN YOU MUST<BR/>&nbsp;&nbsp;&nbsp;at the time when personal data are obtained, provide the data subject with all of the following information[communicate_at_time(Controller, Subject, Time, the legitimate interests pursued by the controller or by a third party[legitimate_interest_third_party_or(Party,Controller)])]<BR/> AND &nbsp;&nbsp;IF<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NOT<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the data subject already has the information[already_has(Subject, the recipients or categories of recipients of the personal data[recepients_of_data(Recipients)])]<BR/>&nbsp;&nbsp;&nbsp;AND &nbsp;&nbsp;&nbsp;&nbsp;processor[processor(Processor)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND nominated by the controller[nominate(Controller, Processor)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND process the data[personal_data_processed(Processor, Data, Time, Justification, Purpose)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND personal data[personal_data(Data,Subject)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND data subject[data_subject(Subject)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND controller[controller(Controller, Data)]<BR/>&nbsp;&nbsp;AND  if any[recipients_personal_data(Recipients, Data)]<BR/>&nbsp;&nbsp;THEN YOU MUST<BR/>&nbsp;&nbsp;&nbsp;at the time when personal data are obtained, provide the data subject with all of the following information[communicate_at_time(Controller, Subject, Time, the recipients or categories of recipients of the personal data[recepients_of_data(Recipients)])]<BR/> AND &nbsp;&nbsp;IF<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NOT<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the data subject already has the information[already_has(Subject, the fact that the controller intends to transfer personal data to a third country or international organisation and the existence or absence of an adequacy decision by the Commission,[information_of_transfer(Controller, Data, Country, Information)])]<BR/>&nbsp;&nbsp;&nbsp;AND &nbsp;&nbsp;&nbsp;&nbsp;processor[processor(Processor)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND nominated by the controller[nominate(Controller, Processor)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND process the data[personal_data_processed(Processor, Data, Time, Justification, Purpose)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND personal data[personal_data(Data,Subject)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND data subject[data_subject(Subject)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND controller[controller(Controller, Data)]<BR/>&nbsp;&nbsp;AND where applicable[intent_transfer_data_to(Controller, Data, Country)]<BR/>&nbsp;&nbsp;THEN YOU MUST<BR/>&nbsp;&nbsp;&nbsp;at the time when personal data are obtained, provide the data subject with all of the following information[communicate_at_time(Controller, Subject, Time, the fact that the controller intends to transfer personal data to a third country or international organisation and the existence or absence of an adequacy decision by the Commission,[information_of_transfer(Controller, Data, Country, Information)])]<BR/> AND &nbsp;&nbsp;IF<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NOT<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the data subject already has the information[already_has(Subject, reference to the appropriate or suitable safeguards and the means by which to obtain a copy of them or where they have been made available[appropriate_safeguards(Controller, Data, Country, SafeGuards)])]<BR/>&nbsp;&nbsp;&nbsp;AND &nbsp;&nbsp;&nbsp;&nbsp;processor[processor(Processor)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND nominated by the controller[nominate(Controller, Processor)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND process the data[personal_data_processed(Processor, Data, Time, Justification, Purpose)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND personal data[personal_data(Data,Subject)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND data subject[data_subject(Subject)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND controller[controller(Controller, Data)]<BR/>&nbsp;&nbsp;AND in the case of transfers referred to in Article 46 or 47, or the second subparagraph of Article 49(1)[transfer_relates_to(Controller, Data, Country, article_46_47_p2_article_49_1)]<BR/>&nbsp;&nbsp;THEN YOU MUST<BR/>&nbsp;&nbsp;&nbsp;at the time when personal data are obtained, provide the data subject with all of the following information[communicate_at_time(Controller, Subject, Time, reference to the appropriate or suitable safeguards and the means by which to obtain a copy of them or where they have been made available[appropriate_safeguards(Controller, Data, Country, SafeGuards)])]<BR/>")
    done();
  })

  it("should parse correctly obmacro1 in art13-2", function(done) {
    let gdpr = JSON.parse(json_art13_2)
    assert.equal(exporter.exportFormula(gdpr, {level:1, map: new Map()}), "&nbsp;a13_p2)&nbsp;&nbsp;IF<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NOT<BR/>&nbsp;&nbsp;&nbsp;&nbsp;the data subject already has the information[already_has(Subject, the period for which the personal data will be stored[stored_during(Data, Period)])]<BR/>&nbsp;&nbsp;AND &nbsp;&nbsp;&nbsp;processor[processor(Processor)]<BR/>&nbsp;&nbsp;&nbsp;AND nominated by the controller[nominate(Controller, Processor)]<BR/>&nbsp;&nbsp;&nbsp;AND process the data[personal_data_processed(Processor, Data, Time, Justification, Purpose)]<BR/>&nbsp;&nbsp;&nbsp;AND personal data[personal_data(Data,Subject)]<BR/>&nbsp;&nbsp;&nbsp;AND data subject[data_subject(Subject)]<BR/>&nbsp;&nbsp;&nbsp;AND controller[controller(Controller, Data)]<BR/>&nbsp;&nbsp;THEN YOU MUST<BR/>&nbsp;&nbsp;&nbsp;at the time when personal data are obtained[communicate_at_time(Controller, Subject, Time, the period for which the personal data will be stored[stored_during(Data, Period)])]<BR/> AND &nbsp;&nbsp;IF<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NOT<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the data subject already has the information[already_has(Subject, the criteria used to determine that period[criteria_storing_data(Data,Criteria)])]<BR/>&nbsp;&nbsp;&nbsp;AND &nbsp;&nbsp;&nbsp;&nbsp;processor[processor(Processor)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND nominated by the controller[nominate(Controller, Processor)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND process the data[personal_data_processed(Processor, Data, Time, Justification, Purpose)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND personal data[personal_data(Data,Subject)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND data subject[data_subject(Subject)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND controller[controller(Controller, Data)]<BR/>&nbsp;&nbsp;AND &nbsp;&nbsp;&nbsp;NOT<BR/>&nbsp;&nbsp;&nbsp;&nbsp;that is not possible[stored_during(Data, Period)]<BR/>&nbsp;&nbsp;THEN YOU MUST<BR/>&nbsp;&nbsp;&nbsp;at the time when personal data are obtained[communicate_at_time(Controller, Subject, Time, the criteria used to determine that period[criteria_storing_data(Data,Criteria)])]<BR/> AND &nbsp;&nbsp;IF<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NOT<BR/>&nbsp;&nbsp;&nbsp;&nbsp;the data subject already has the information[already_has(Subject,  the existence of the right to request from the controller access to and rectification or erasure of personal data or restriction of processing concerning the data subject or to object to processing as well as the right to data portability[existence_right_of(Controller, Subject, Data, access_rectification_etc)])]<BR/>&nbsp;&nbsp;AND &nbsp;&nbsp;&nbsp;processor[processor(Processor)]<BR/>&nbsp;&nbsp;&nbsp;AND nominated by the controller[nominate(Controller, Processor)]<BR/>&nbsp;&nbsp;&nbsp;AND process the data[personal_data_processed(Processor, Data, Time, Justification, Purpose)]<BR/>&nbsp;&nbsp;&nbsp;AND personal data[personal_data(Data,Subject)]<BR/>&nbsp;&nbsp;&nbsp;AND data subject[data_subject(Subject)]<BR/>&nbsp;&nbsp;&nbsp;AND controller[controller(Controller, Data)]<BR/>&nbsp;&nbsp;THEN YOU MUST<BR/>&nbsp;&nbsp;&nbsp;at the time when personal data are obtained[communicate_at_time(Controller, Subject, Time,  the existence of the right to request from the controller access to and rectification or erasure of personal data or restriction of processing concerning the data subject or to object to processing as well as the right to data portability[existence_right_of(Controller, Subject, Data, access_rectification_etc)])]<BR/> AND &nbsp;&nbsp;IF<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NOT<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the data subject already has the information[already_has(Subject, the existence of the right to withdraw consent at any time, without affecting the lawfulness of processing based on consent before its withdrawal[existence_right_of(Controller, Subject, Data, withdraw_consent_etc)])]<BR/>&nbsp;&nbsp;&nbsp;AND &nbsp;&nbsp;&nbsp;&nbsp;processor[processor(Processor)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND nominated by the controller[nominate(Controller, Processor)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND process the data[personal_data_processed(Processor, Data, Time, Justification, Purpose)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND personal data[personal_data(Data,Subject)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND data subject[data_subject(Subject)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND controller[controller(Controller, Data)]<BR/>&nbsp;&nbsp;AND  where the processing is based on point (a) of Article 6(1) or point (a) of Article 9(2)[personal_data_processed_at_time(Processor, Data, Time, article_6_1_article_9_2_a)]<BR/>&nbsp;&nbsp;THEN YOU MUST<BR/>&nbsp;&nbsp;&nbsp;at the time when personal data are obtained[communicate_at_time(Controller, Subject, Time, the existence of the right to withdraw consent at any time, without affecting the lawfulness of processing based on consent before its withdrawal[existence_right_of(Controller, Subject, Data, withdraw_consent_etc)])]<BR/> AND &nbsp;&nbsp;IF<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NOT<BR/>&nbsp;&nbsp;&nbsp;&nbsp;the data subject already has the information[already_has(Subject, the right to lodge a complaint with a supervisory authority[existence_right_of(Controller, Subject, Data, lodge_complaint)])]<BR/>&nbsp;&nbsp;AND &nbsp;&nbsp;&nbsp;processor[processor(Processor)]<BR/>&nbsp;&nbsp;&nbsp;AND nominated by the controller[nominate(Controller, Processor)]<BR/>&nbsp;&nbsp;&nbsp;AND process the data[personal_data_processed(Processor, Data, Time, Justification, Purpose)]<BR/>&nbsp;&nbsp;&nbsp;AND personal data[personal_data(Data,Subject)]<BR/>&nbsp;&nbsp;&nbsp;AND data subject[data_subject(Subject)]<BR/>&nbsp;&nbsp;&nbsp;AND controller[controller(Controller, Data)]<BR/>&nbsp;&nbsp;THEN YOU MUST<BR/>&nbsp;&nbsp;&nbsp;at the time when personal data are obtained[communicate_at_time(Controller, Subject, Time, the right to lodge a complaint with a supervisory authority[existence_right_of(Controller, Subject, Data, lodge_complaint)])]<BR/> AND &nbsp;&nbsp;IF<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NOT<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the data subject already has the information[already_has(Subject, or a requirement necessary to enter into a contract[info(ProvisionType)])]<BR/>&nbsp;&nbsp;&nbsp;AND &nbsp;&nbsp;&nbsp;&nbsp;processor[processor(Processor)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND nominated by the controller[nominate(Controller, Processor)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND process the data[personal_data_processed(Processor, Data, Time, Justification, Purpose)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND personal data[personal_data(Data,Subject)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND data subject[data_subject(Subject)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND controller[controller(Controller, Data)]<BR/>&nbsp;&nbsp;AND whether the provision of personal data is a statutory or contractual requirement[type_provision(Subject, Data, ProvisionType)]<BR/>&nbsp;&nbsp;THEN YOU MUST<BR/>&nbsp;&nbsp;&nbsp;at the time when personal data are obtained[communicate_at_time(Controller, Subject, Time, or a requirement necessary to enter into a contract[info(ProvisionType)])]<BR/> AND &nbsp;&nbsp;IF<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NOT<BR/>&nbsp;&nbsp;&nbsp;&nbsp;the data subject already has the information[already_has(Subject, ,[info(ProvisionType)])]<BR/>&nbsp;&nbsp;AND &nbsp;&nbsp;&nbsp;processor[processor(Processor)]<BR/>&nbsp;&nbsp;&nbsp;AND nominated by the controller[nominate(Controller, Processor)]<BR/>&nbsp;&nbsp;&nbsp;AND process the data[personal_data_processed(Processor, Data, Time, Justification, Purpose)]<BR/>&nbsp;&nbsp;&nbsp;AND personal data[personal_data(Data,Subject)]<BR/>&nbsp;&nbsp;&nbsp;AND data subject[data_subject(Subject)]<BR/>&nbsp;&nbsp;&nbsp;AND controller[controller(Controller, Data)]<BR/>&nbsp;&nbsp;THEN YOU MUST<BR/>&nbsp;&nbsp;&nbsp;at the time when personal data are obtained[communicate_at_time(Controller, Subject, Time, ,[info(ProvisionType)])]<BR/> AND &nbsp;&nbsp;IF<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NOT<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the data subject already has the information[already_has(Subject, whether[info_obliged_give_data(IsObliged, Consequences)])]<BR/>&nbsp;&nbsp;&nbsp;AND &nbsp;&nbsp;&nbsp;&nbsp;processor[processor(Processor)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND nominated by the controller[nominate(Controller, Processor)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND process the data[personal_data_processed(Processor, Data, Time, Justification, Purpose)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND personal data[personal_data(Data,Subject)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND data subject[data_subject(Subject)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND controller[controller(Controller, Data)]<BR/>&nbsp;&nbsp;AND &nbsp;&nbsp;&nbsp;data subject is obliged to provide the personal data[is_obliged_to_give(Subject,Data,IsObliged)]<BR/>&nbsp;&nbsp;&nbsp;AND possible consequences of failure to provide such data[consequence_refusing_to_give(Subject,Data, Consequences)]<BR/>&nbsp;&nbsp;THEN YOU MUST<BR/>&nbsp;&nbsp;&nbsp;at the time when personal data are obtained[communicate_at_time(Controller, Subject, Time, whether[info_obliged_give_data(IsObliged, Consequences)])]<BR/> AND &nbsp;&nbsp;IF<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NOT<BR/>&nbsp;&nbsp;&nbsp;&nbsp;the data subject already has the information[already_has(Subject, the existence of automated decision-making, including profiling, referred to in Article 22(1) and (4) and, at least in those cases, meaningful information about the logic involved, as well as the significance and the envisaged consequences of such processing for the data subject[existence_ai(Data,Algorithm)])]<BR/>&nbsp;&nbsp;AND &nbsp;&nbsp;&nbsp;processor[processor(Processor)]<BR/>&nbsp;&nbsp;&nbsp;AND nominated by the controller[nominate(Controller, Processor)]<BR/>&nbsp;&nbsp;&nbsp;AND process the data[personal_data_processed(Processor, Data, Time, Justification, Purpose)]<BR/>&nbsp;&nbsp;&nbsp;AND personal data[personal_data(Data,Subject)]<BR/>&nbsp;&nbsp;&nbsp;AND data subject[data_subject(Subject)]<BR/>&nbsp;&nbsp;&nbsp;AND controller[controller(Controller, Data)]<BR/>&nbsp;&nbsp;THEN YOU MUST<BR/>&nbsp;&nbsp;&nbsp;at the time when personal data are obtained[communicate_at_time(Controller, Subject, Time, the existence of automated decision-making, including profiling, referred to in Article 22(1) and (4) and, at least in those cases, meaningful information about the logic involved, as well as the significance and the envisaged consequences of such processing for the data subject[existence_ai(Data,Algorithm)])]<BR/>")
    done();
  })

  it("should parse correctly obmacro1-copy in art13-3", function(done) {
    let gdpr = JSON.parse(json_art13_3)
    let gdpr2 = JSON.parse(json_art13_2)
    let map = new Map();
    exporter.exportFormula(gdpr2, {level:1, map: map})
    assert.equal(exporter.exportFormula(gdpr, {level:1, map: map}), "&nbsp;a13_p3)&nbsp;&nbsp;IF<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;intends to further[earlier(Time,Time2)]<BR/>&nbsp;&nbsp;&nbsp;AND process the personal data[personal_data_processed(Processor, Data, Time2, Justification2, Purpose2)]<BR/>&nbsp;&nbsp;&nbsp;AND for a purpose other than that for which the personal data were collected[different_from(Purpose2, Purpose)]<BR/>&nbsp;&nbsp;AND &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NOT<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the data subject already has the information[already_has(Subject, information on that other purpose[purpose_of_processing(Purpose2, Data)])]<BR/>&nbsp;&nbsp;&nbsp;AND &nbsp;&nbsp;&nbsp;&nbsp;processor[processor(Processor)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND nominated by the controller[nominate(Controller, Processor)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND process the data[personal_data_processed(Processor, Data, Time, Justification, Purpose)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND personal data[personal_data(Data,Subject)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND data subject[data_subject(Subject)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND controller[controller(Controller, Data)]<BR/>&nbsp;&nbsp;THEN YOU MUST<BR/>&nbsp;&nbsp;&nbsp;controller shall provide the data subject prior to that further processing[communicate_at_time(Controller, Subject, Time2, information on that other purpose[purpose_of_processing(Purpose2, Data)])]<BR/> AND &nbsp;&nbsp;IF<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;intends to further[earlier(Time,Time2)]<BR/>&nbsp;&nbsp;&nbsp;AND process the personal data[personal_data_processed(Processor, Data, Time2, Justification2, Purpose2)]<BR/>&nbsp;&nbsp;&nbsp;AND for a purpose other than that for which the personal data were collected[different_from(Purpose2, Purpose)]<BR/>&nbsp;&nbsp;AND &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NOT<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the data subject already has the information[already_has(Subject, the period for which the personal data will be stored[stored_during(Data, Period)])]<BR/>&nbsp;&nbsp;&nbsp;AND &nbsp;&nbsp;&nbsp;&nbsp;processor[processor(Processor)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND nominated by the controller[nominate(Controller, Processor)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND process the data[personal_data_processed(Processor, Data, Time, Justification, Purpose)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND personal data[personal_data(Data,Subject)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND data subject[data_subject(Subject)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND controller[controller(Controller, Data)]<BR/>&nbsp;&nbsp;THEN YOU MUST<BR/>&nbsp;&nbsp;&nbsp;controller shall provide the data subject prior to that further processing[communicate_at_time(Controller, Subject, Time2, the period for which the personal data will be stored[stored_during(Data, Period)])]<BR/> AND &nbsp;&nbsp;IF<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;intends to further[earlier(Time,Time2)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND process the personal data[personal_data_processed(Processor, Data, Time2, Justification2, Purpose2)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND for a purpose other than that for which the personal data were collected[different_from(Purpose2, Purpose)]<BR/>&nbsp;&nbsp;&nbsp;AND &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NOT<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the data subject already has the information[already_has(Subject, the criteria used to determine that period[criteria_storing_data(Data,Criteria)])]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;processor[processor(Processor)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND nominated by the controller[nominate(Controller, Processor)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND process the data[personal_data_processed(Processor, Data, Time, Justification, Purpose)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND personal data[personal_data(Data,Subject)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND data subject[data_subject(Subject)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND controller[controller(Controller, Data)]<BR/>&nbsp;&nbsp;AND &nbsp;&nbsp;&nbsp;NOT<BR/>&nbsp;&nbsp;&nbsp;&nbsp;that is not possible[stored_during(Data, Period)]<BR/>&nbsp;&nbsp;THEN YOU MUST<BR/>&nbsp;&nbsp;&nbsp;controller shall provide the data subject prior to that further processing[communicate_at_time(Controller, Subject, Time2, the criteria used to determine that period[criteria_storing_data(Data,Criteria)])]<BR/> AND &nbsp;&nbsp;IF<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;intends to further[earlier(Time,Time2)]<BR/>&nbsp;&nbsp;&nbsp;AND process the personal data[personal_data_processed(Processor, Data, Time2, Justification2, Purpose2)]<BR/>&nbsp;&nbsp;&nbsp;AND for a purpose other than that for which the personal data were collected[different_from(Purpose2, Purpose)]<BR/>&nbsp;&nbsp;AND &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NOT<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the data subject already has the information[already_has(Subject,  the existence of the right to request from the controller access to and rectification or erasure of personal data or restriction of processing concerning the data subject or to object to processing as well as the right to data portability[existence_right_of(Controller, Subject, Data, access_rectification_etc)])]<BR/>&nbsp;&nbsp;&nbsp;AND &nbsp;&nbsp;&nbsp;&nbsp;processor[processor(Processor)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND nominated by the controller[nominate(Controller, Processor)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND process the data[personal_data_processed(Processor, Data, Time, Justification, Purpose)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND personal data[personal_data(Data,Subject)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND data subject[data_subject(Subject)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND controller[controller(Controller, Data)]<BR/>&nbsp;&nbsp;THEN YOU MUST<BR/>&nbsp;&nbsp;&nbsp;controller shall provide the data subject prior to that further processing[communicate_at_time(Controller, Subject, Time2,  the existence of the right to request from the controller access to and rectification or erasure of personal data or restriction of processing concerning the data subject or to object to processing as well as the right to data portability[existence_right_of(Controller, Subject, Data, access_rectification_etc)])]<BR/> AND &nbsp;&nbsp;IF<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;intends to further[earlier(Time,Time2)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND process the personal data[personal_data_processed(Processor, Data, Time2, Justification2, Purpose2)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND for a purpose other than that for which the personal data were collected[different_from(Purpose2, Purpose)]<BR/>&nbsp;&nbsp;&nbsp;AND &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NOT<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the data subject already has the information[already_has(Subject, the existence of the right to withdraw consent at any time, without affecting the lawfulness of processing based on consent before its withdrawal[existence_right_of(Controller, Subject, Data, withdraw_consent_etc)])]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;processor[processor(Processor)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND nominated by the controller[nominate(Controller, Processor)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND process the data[personal_data_processed(Processor, Data, Time, Justification, Purpose)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND personal data[personal_data(Data,Subject)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND data subject[data_subject(Subject)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND controller[controller(Controller, Data)]<BR/>&nbsp;&nbsp;AND  where the processing is based on point (a) of Article 6(1) or point (a) of Article 9(2)[personal_data_processed_at_time(Processor, Data, Time, article_6_1_article_9_2_a)]<BR/>&nbsp;&nbsp;THEN YOU MUST<BR/>&nbsp;&nbsp;&nbsp;controller shall provide the data subject prior to that further processing[communicate_at_time(Controller, Subject, Time2, the existence of the right to withdraw consent at any time, without affecting the lawfulness of processing based on consent before its withdrawal[existence_right_of(Controller, Subject, Data, withdraw_consent_etc)])]<BR/> AND &nbsp;&nbsp;IF<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;intends to further[earlier(Time,Time2)]<BR/>&nbsp;&nbsp;&nbsp;AND process the personal data[personal_data_processed(Processor, Data, Time2, Justification2, Purpose2)]<BR/>&nbsp;&nbsp;&nbsp;AND for a purpose other than that for which the personal data were collected[different_from(Purpose2, Purpose)]<BR/>&nbsp;&nbsp;AND &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NOT<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the data subject already has the information[already_has(Subject, the right to lodge a complaint with a supervisory authority[existence_right_of(Controller, Subject, Data, lodge_complaint)])]<BR/>&nbsp;&nbsp;&nbsp;AND &nbsp;&nbsp;&nbsp;&nbsp;processor[processor(Processor)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND nominated by the controller[nominate(Controller, Processor)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND process the data[personal_data_processed(Processor, Data, Time, Justification, Purpose)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND personal data[personal_data(Data,Subject)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND data subject[data_subject(Subject)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND controller[controller(Controller, Data)]<BR/>&nbsp;&nbsp;THEN YOU MUST<BR/>&nbsp;&nbsp;&nbsp;controller shall provide the data subject prior to that further processing[communicate_at_time(Controller, Subject, Time2, the right to lodge a complaint with a supervisory authority[existence_right_of(Controller, Subject, Data, lodge_complaint)])]<BR/> AND &nbsp;&nbsp;IF<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;intends to further[earlier(Time,Time2)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND process the personal data[personal_data_processed(Processor, Data, Time2, Justification2, Purpose2)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND for a purpose other than that for which the personal data were collected[different_from(Purpose2, Purpose)]<BR/>&nbsp;&nbsp;&nbsp;AND &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NOT<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the data subject already has the information[already_has(Subject, or a requirement necessary to enter into a contract[info(ProvisionType)])]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;processor[processor(Processor)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND nominated by the controller[nominate(Controller, Processor)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND process the data[personal_data_processed(Processor, Data, Time, Justification, Purpose)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND personal data[personal_data(Data,Subject)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND data subject[data_subject(Subject)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND controller[controller(Controller, Data)]<BR/>&nbsp;&nbsp;AND whether the provision of personal data is a statutory or contractual requirement[type_provision(Subject, Data, ProvisionType)]<BR/>&nbsp;&nbsp;THEN YOU MUST<BR/>&nbsp;&nbsp;&nbsp;controller shall provide the data subject prior to that further processing[communicate_at_time(Controller, Subject, Time2, or a requirement necessary to enter into a contract[info(ProvisionType)])]<BR/> AND &nbsp;&nbsp;IF<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;intends to further[earlier(Time,Time2)]<BR/>&nbsp;&nbsp;&nbsp;AND process the personal data[personal_data_processed(Processor, Data, Time2, Justification2, Purpose2)]<BR/>&nbsp;&nbsp;&nbsp;AND for a purpose other than that for which the personal data were collected[different_from(Purpose2, Purpose)]<BR/>&nbsp;&nbsp;AND &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NOT<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the data subject already has the information[already_has(Subject, ,[info(ProvisionType)])]<BR/>&nbsp;&nbsp;&nbsp;AND &nbsp;&nbsp;&nbsp;&nbsp;processor[processor(Processor)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND nominated by the controller[nominate(Controller, Processor)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND process the data[personal_data_processed(Processor, Data, Time, Justification, Purpose)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND personal data[personal_data(Data,Subject)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND data subject[data_subject(Subject)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND controller[controller(Controller, Data)]<BR/>&nbsp;&nbsp;THEN YOU MUST<BR/>&nbsp;&nbsp;&nbsp;controller shall provide the data subject prior to that further processing[communicate_at_time(Controller, Subject, Time2, ,[info(ProvisionType)])]<BR/> AND &nbsp;&nbsp;IF<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;intends to further[earlier(Time,Time2)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND process the personal data[personal_data_processed(Processor, Data, Time2, Justification2, Purpose2)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND for a purpose other than that for which the personal data were collected[different_from(Purpose2, Purpose)]<BR/>&nbsp;&nbsp;&nbsp;AND &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NOT<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the data subject already has the information[already_has(Subject, whether[info_obliged_give_data(IsObliged, Consequences)])]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;processor[processor(Processor)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND nominated by the controller[nominate(Controller, Processor)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND process the data[personal_data_processed(Processor, Data, Time, Justification, Purpose)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND personal data[personal_data(Data,Subject)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND data subject[data_subject(Subject)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND controller[controller(Controller, Data)]<BR/>&nbsp;&nbsp;AND &nbsp;&nbsp;&nbsp;data subject is obliged to provide the personal data[is_obliged_to_give(Subject,Data,IsObliged)]<BR/>&nbsp;&nbsp;&nbsp;AND possible consequences of failure to provide such data[consequence_refusing_to_give(Subject,Data, Consequences)]<BR/>&nbsp;&nbsp;THEN YOU MUST<BR/>&nbsp;&nbsp;&nbsp;controller shall provide the data subject prior to that further processing[communicate_at_time(Controller, Subject, Time2, whether[info_obliged_give_data(IsObliged, Consequences)])]<BR/> AND &nbsp;&nbsp;IF<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;intends to further[earlier(Time,Time2)]<BR/>&nbsp;&nbsp;&nbsp;AND process the personal data[personal_data_processed(Processor, Data, Time2, Justification2, Purpose2)]<BR/>&nbsp;&nbsp;&nbsp;AND for a purpose other than that for which the personal data were collected[different_from(Purpose2, Purpose)]<BR/>&nbsp;&nbsp;AND &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NOT<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the data subject already has the information[already_has(Subject, the existence of automated decision-making, including profiling, referred to in Article 22(1) and (4) and, at least in those cases, meaningful information about the logic involved, as well as the significance and the envisaged consequences of such processing for the data subject[existence_ai(Data,Algorithm)])]<BR/>&nbsp;&nbsp;&nbsp;AND &nbsp;&nbsp;&nbsp;&nbsp;processor[processor(Processor)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND nominated by the controller[nominate(Controller, Processor)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND process the data[personal_data_processed(Processor, Data, Time, Justification, Purpose)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND personal data[personal_data(Data,Subject)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND data subject[data_subject(Subject)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND controller[controller(Controller, Data)]<BR/>&nbsp;&nbsp;THEN YOU MUST<BR/>&nbsp;&nbsp;&nbsp;controller shall provide the data subject prior to that further processing[communicate_at_time(Controller, Subject, Time2, the existence of automated decision-making, including profiling, referred to in Article 22(1) and (4) and, at least in those cases, meaningful information about the logic involved, as well as the significance and the envisaged consequences of such processing for the data subject[existence_ai(Data,Algorithm)])]<BR/>")
    done();
  })

  it("should parse correctly exception in art13-4", function(done) {
    let gdpr = JSON.parse(json_art13_4)
    let gdpr1 = JSON.parse(json_art13_1)
    let gdpr2 = JSON.parse(json_art13_2)
    let gdpr3 = JSON.parse(json_art13_3)
    let map = new Map();
    exporter.exportFormula(gdpr1, {level:1, map: map})
    exporter.exportFormula(gdpr2, {level:1, map: map})
    exporter.exportFormula(gdpr3, {level:1, map: map})
    assert.equal(exporter.exportFormula(gdpr, {level:1, map: map}), "&nbsp;a13_p3)&nbsp;&nbsp;IF<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;intends to further[earlier(Time,Time2)]<BR/>&nbsp;&nbsp;&nbsp;AND process the personal data[personal_data_processed(Processor, Data, Time2, Justification2, Purpose2)]<BR/>&nbsp;&nbsp;&nbsp;AND for a purpose other than that for which the personal data were collected[different_from(Purpose2, Purpose)]<BR/>&nbsp;&nbsp;AND &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NOT<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the data subject already has the information[already_has(Subject, information on that other purpose[purpose_of_processing(Purpose2, Data)])]<BR/>&nbsp;&nbsp;&nbsp;AND &nbsp;&nbsp;&nbsp;&nbsp;processor[processor(Processor)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND nominated by the controller[nominate(Controller, Processor)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND process the data[personal_data_processed(Processor, Data, Time, Justification, Purpose)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND personal data[personal_data(Data,Subject)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND data subject[data_subject(Subject)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND controller[controller(Controller, Data)]<BR/>&nbsp;&nbsp;THEN YOU MUST<BR/>&nbsp;&nbsp;&nbsp;controller shall provide the data subject prior to that further processing[communicate_at_time(Controller, Subject, Time2, information on that other purpose[purpose_of_processing(Purpose2, Data)])]<BR/> AND &nbsp;&nbsp;IF<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;intends to further[earlier(Time,Time2)]<BR/>&nbsp;&nbsp;&nbsp;AND process the personal data[personal_data_processed(Processor, Data, Time2, Justification2, Purpose2)]<BR/>&nbsp;&nbsp;&nbsp;AND for a purpose other than that for which the personal data were collected[different_from(Purpose2, Purpose)]<BR/>&nbsp;&nbsp;AND &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NOT<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the data subject already has the information[already_has(Subject, the period for which the personal data will be stored[stored_during(Data, Period)])]<BR/>&nbsp;&nbsp;&nbsp;AND &nbsp;&nbsp;&nbsp;&nbsp;processor[processor(Processor)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND nominated by the controller[nominate(Controller, Processor)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND process the data[personal_data_processed(Processor, Data, Time, Justification, Purpose)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND personal data[personal_data(Data,Subject)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND data subject[data_subject(Subject)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND controller[controller(Controller, Data)]<BR/>&nbsp;&nbsp;THEN YOU MUST<BR/>&nbsp;&nbsp;&nbsp;controller shall provide the data subject prior to that further processing[communicate_at_time(Controller, Subject, Time2, the period for which the personal data will be stored[stored_during(Data, Period)])]<BR/> AND &nbsp;&nbsp;IF<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;intends to further[earlier(Time,Time2)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND process the personal data[personal_data_processed(Processor, Data, Time2, Justification2, Purpose2)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND for a purpose other than that for which the personal data were collected[different_from(Purpose2, Purpose)]<BR/>&nbsp;&nbsp;&nbsp;AND &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NOT<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the data subject already has the information[already_has(Subject, the criteria used to determine that period[criteria_storing_data(Data,Criteria)])]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;processor[processor(Processor)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND nominated by the controller[nominate(Controller, Processor)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND process the data[personal_data_processed(Processor, Data, Time, Justification, Purpose)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND personal data[personal_data(Data,Subject)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND data subject[data_subject(Subject)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND controller[controller(Controller, Data)]<BR/>&nbsp;&nbsp;AND &nbsp;&nbsp;&nbsp;NOT<BR/>&nbsp;&nbsp;&nbsp;&nbsp;that is not possible[stored_during(Data, Period)]<BR/>&nbsp;&nbsp;THEN YOU MUST<BR/>&nbsp;&nbsp;&nbsp;controller shall provide the data subject prior to that further processing[communicate_at_time(Controller, Subject, Time2, the criteria used to determine that period[criteria_storing_data(Data,Criteria)])]<BR/> AND &nbsp;&nbsp;IF<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;intends to further[earlier(Time,Time2)]<BR/>&nbsp;&nbsp;&nbsp;AND process the personal data[personal_data_processed(Processor, Data, Time2, Justification2, Purpose2)]<BR/>&nbsp;&nbsp;&nbsp;AND for a purpose other than that for which the personal data were collected[different_from(Purpose2, Purpose)]<BR/>&nbsp;&nbsp;AND &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NOT<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the data subject already has the information[already_has(Subject,  the existence of the right to request from the controller access to and rectification or erasure of personal data or restriction of processing concerning the data subject or to object to processing as well as the right to data portability[existence_right_of(Controller, Subject, Data, access_rectification_etc)])]<BR/>&nbsp;&nbsp;&nbsp;AND &nbsp;&nbsp;&nbsp;&nbsp;processor[processor(Processor)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND nominated by the controller[nominate(Controller, Processor)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND process the data[personal_data_processed(Processor, Data, Time, Justification, Purpose)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND personal data[personal_data(Data,Subject)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND data subject[data_subject(Subject)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND controller[controller(Controller, Data)]<BR/>&nbsp;&nbsp;THEN YOU MUST<BR/>&nbsp;&nbsp;&nbsp;controller shall provide the data subject prior to that further processing[communicate_at_time(Controller, Subject, Time2,  the existence of the right to request from the controller access to and rectification or erasure of personal data or restriction of processing concerning the data subject or to object to processing as well as the right to data portability[existence_right_of(Controller, Subject, Data, access_rectification_etc)])]<BR/> AND &nbsp;&nbsp;IF<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;intends to further[earlier(Time,Time2)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND process the personal data[personal_data_processed(Processor, Data, Time2, Justification2, Purpose2)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND for a purpose other than that for which the personal data were collected[different_from(Purpose2, Purpose)]<BR/>&nbsp;&nbsp;&nbsp;AND &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NOT<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the data subject already has the information[already_has(Subject, the existence of the right to withdraw consent at any time, without affecting the lawfulness of processing based on consent before its withdrawal[existence_right_of(Controller, Subject, Data, withdraw_consent_etc)])]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;processor[processor(Processor)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND nominated by the controller[nominate(Controller, Processor)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND process the data[personal_data_processed(Processor, Data, Time, Justification, Purpose)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND personal data[personal_data(Data,Subject)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND data subject[data_subject(Subject)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND controller[controller(Controller, Data)]<BR/>&nbsp;&nbsp;AND  where the processing is based on point (a) of Article 6(1) or point (a) of Article 9(2)[personal_data_processed_at_time(Processor, Data, Time, article_6_1_article_9_2_a)]<BR/>&nbsp;&nbsp;THEN YOU MUST<BR/>&nbsp;&nbsp;&nbsp;controller shall provide the data subject prior to that further processing[communicate_at_time(Controller, Subject, Time2, the existence of the right to withdraw consent at any time, without affecting the lawfulness of processing based on consent before its withdrawal[existence_right_of(Controller, Subject, Data, withdraw_consent_etc)])]<BR/> AND &nbsp;&nbsp;IF<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;intends to further[earlier(Time,Time2)]<BR/>&nbsp;&nbsp;&nbsp;AND process the personal data[personal_data_processed(Processor, Data, Time2, Justification2, Purpose2)]<BR/>&nbsp;&nbsp;&nbsp;AND for a purpose other than that for which the personal data were collected[different_from(Purpose2, Purpose)]<BR/>&nbsp;&nbsp;AND &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NOT<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the data subject already has the information[already_has(Subject, the right to lodge a complaint with a supervisory authority[existence_right_of(Controller, Subject, Data, lodge_complaint)])]<BR/>&nbsp;&nbsp;&nbsp;AND &nbsp;&nbsp;&nbsp;&nbsp;processor[processor(Processor)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND nominated by the controller[nominate(Controller, Processor)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND process the data[personal_data_processed(Processor, Data, Time, Justification, Purpose)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND personal data[personal_data(Data,Subject)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND data subject[data_subject(Subject)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND controller[controller(Controller, Data)]<BR/>&nbsp;&nbsp;THEN YOU MUST<BR/>&nbsp;&nbsp;&nbsp;controller shall provide the data subject prior to that further processing[communicate_at_time(Controller, Subject, Time2, the right to lodge a complaint with a supervisory authority[existence_right_of(Controller, Subject, Data, lodge_complaint)])]<BR/> AND &nbsp;&nbsp;IF<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;intends to further[earlier(Time,Time2)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND process the personal data[personal_data_processed(Processor, Data, Time2, Justification2, Purpose2)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND for a purpose other than that for which the personal data were collected[different_from(Purpose2, Purpose)]<BR/>&nbsp;&nbsp;&nbsp;AND &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NOT<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the data subject already has the information[already_has(Subject, or a requirement necessary to enter into a contract[info(ProvisionType)])]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;processor[processor(Processor)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND nominated by the controller[nominate(Controller, Processor)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND process the data[personal_data_processed(Processor, Data, Time, Justification, Purpose)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND personal data[personal_data(Data,Subject)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND data subject[data_subject(Subject)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND controller[controller(Controller, Data)]<BR/>&nbsp;&nbsp;AND whether the provision of personal data is a statutory or contractual requirement[type_provision(Subject, Data, ProvisionType)]<BR/>&nbsp;&nbsp;THEN YOU MUST<BR/>&nbsp;&nbsp;&nbsp;controller shall provide the data subject prior to that further processing[communicate_at_time(Controller, Subject, Time2, or a requirement necessary to enter into a contract[info(ProvisionType)])]<BR/> AND &nbsp;&nbsp;IF<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;intends to further[earlier(Time,Time2)]<BR/>&nbsp;&nbsp;&nbsp;AND process the personal data[personal_data_processed(Processor, Data, Time2, Justification2, Purpose2)]<BR/>&nbsp;&nbsp;&nbsp;AND for a purpose other than that for which the personal data were collected[different_from(Purpose2, Purpose)]<BR/>&nbsp;&nbsp;AND &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NOT<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the data subject already has the information[already_has(Subject, ,[info(ProvisionType)])]<BR/>&nbsp;&nbsp;&nbsp;AND &nbsp;&nbsp;&nbsp;&nbsp;processor[processor(Processor)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND nominated by the controller[nominate(Controller, Processor)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND process the data[personal_data_processed(Processor, Data, Time, Justification, Purpose)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND personal data[personal_data(Data,Subject)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND data subject[data_subject(Subject)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND controller[controller(Controller, Data)]<BR/>&nbsp;&nbsp;THEN YOU MUST<BR/>&nbsp;&nbsp;&nbsp;controller shall provide the data subject prior to that further processing[communicate_at_time(Controller, Subject, Time2, ,[info(ProvisionType)])]<BR/> AND &nbsp;&nbsp;IF<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;intends to further[earlier(Time,Time2)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND process the personal data[personal_data_processed(Processor, Data, Time2, Justification2, Purpose2)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND for a purpose other than that for which the personal data were collected[different_from(Purpose2, Purpose)]<BR/>&nbsp;&nbsp;&nbsp;AND &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NOT<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the data subject already has the information[already_has(Subject, whether[info_obliged_give_data(IsObliged, Consequences)])]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;processor[processor(Processor)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND nominated by the controller[nominate(Controller, Processor)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND process the data[personal_data_processed(Processor, Data, Time, Justification, Purpose)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND personal data[personal_data(Data,Subject)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND data subject[data_subject(Subject)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND controller[controller(Controller, Data)]<BR/>&nbsp;&nbsp;AND &nbsp;&nbsp;&nbsp;data subject is obliged to provide the personal data[is_obliged_to_give(Subject,Data,IsObliged)]<BR/>&nbsp;&nbsp;&nbsp;AND possible consequences of failure to provide such data[consequence_refusing_to_give(Subject,Data, Consequences)]<BR/>&nbsp;&nbsp;THEN YOU MUST<BR/>&nbsp;&nbsp;&nbsp;controller shall provide the data subject prior to that further processing[communicate_at_time(Controller, Subject, Time2, whether[info_obliged_give_data(IsObliged, Consequences)])]<BR/> AND &nbsp;&nbsp;IF<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;intends to further[earlier(Time,Time2)]<BR/>&nbsp;&nbsp;&nbsp;AND process the personal data[personal_data_processed(Processor, Data, Time2, Justification2, Purpose2)]<BR/>&nbsp;&nbsp;&nbsp;AND for a purpose other than that for which the personal data were collected[different_from(Purpose2, Purpose)]<BR/>&nbsp;&nbsp;AND &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NOT<BR/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the data subject already has the information[already_has(Subject, the existence of automated decision-making, including profiling, referred to in Article 22(1) and (4) and, at least in those cases, meaningful information about the logic involved, as well as the significance and the envisaged consequences of such processing for the data subject[existence_ai(Data,Algorithm)])]<BR/>&nbsp;&nbsp;&nbsp;AND &nbsp;&nbsp;&nbsp;&nbsp;processor[processor(Processor)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND nominated by the controller[nominate(Controller, Processor)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND process the data[personal_data_processed(Processor, Data, Time, Justification, Purpose)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND personal data[personal_data(Data,Subject)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND data subject[data_subject(Subject)]<BR/>&nbsp;&nbsp;&nbsp;&nbsp;AND controller[controller(Controller, Data)]<BR/>&nbsp;&nbsp;THEN YOU MUST<BR/>&nbsp;&nbsp;&nbsp;controller shall provide the data subject prior to that further processing[communicate_at_time(Controller, Subject, Time2, the existence of automated decision-making, including profiling, referred to in Article 22(1) and (4) and, at least in those cases, meaningful information about the logic involved, as well as the significance and the envisaged consequences of such processing for the data subject[existence_ai(Data,Algorithm)])]<BR/>")
    done();
  })


})

